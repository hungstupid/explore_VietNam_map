<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Vibe UI + Weather + Map</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ["Inter", "ui-sans-serif", "system-ui"] },
          colors: {
            brand: {
              50:"#eef2ff",100:"#e0e7ff",200:"#c7d2fe",300:"#a5b4fc",
              400:"#818cf8",500:"#6366f1",600:"#4f46e5",700:"#4338ca",
              800:"#3730a3",900:"#312e81"
            }
          }
        }
      }
    }
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />

  <style>
    #map {
      height: 420px;
      border-radius: 20px;
      overflow: hidden;
      z-index: 0; /* Fix l·ªói ƒë√® l√™n c√°c th√†nh ph·∫ßn kh√°c */
    }
  </style>

</head>
<body class="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 text-slate-900">
  <div class="max-w-4xl mx-auto p-6">
    <header class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="h-10 w-10 rounded-2xl bg-brand-600 shadow-lg flex items-center justify-center text-white font-bold">V</div>
        <h1 class="text-2xl font-bold tracking-tight">Vibe UI</h1>
      </div>
      <div id="authArea" class="flex items-center gap-3">
        <button id="btnSignIn" class="hidden px-4 py-2 rounded-xl bg-brand-600 text-white font-semibold shadow hover:bg-brand-700 active:scale-[.98]">
          ƒêƒÉng nh·∫≠p Google
        </button>
        <div id="userChip" class="hidden items-center gap-2 px-3 py-1.5 rounded-full bg-white border border-slate-200 shadow">
          <img id="avatar" class="h-7 w-7 rounded-full" alt="avatar">
          <span id="displayName" class="text-sm font-semibold"></span>
          <button id="btnSignOut" class="ml-2 text-xs px-2 py-1 rounded-lg bg-slate-100 hover:bg-slate-200">Tho√°t</button>
        </div>
      </div>
    </header>

    <section class="mt-8">
      <div class="rounded-3xl p-6 md:p-10 bg-white border border-slate-200 shadow-xl">
        <h2 class="text-xl md:text-2xl font-bold">Du l·ªãch & Th·ªùi ti·∫øt th√¥ng minh</h2>
        <p class="mt-2 text-slate-600">T√¨m ƒë·ªãa ƒëi·ªÉm, xem th·ªùi ti·∫øt hi·ªán t·∫°i v√† l∆∞u ghi ch√∫ h√†nh tr√¨nh.</p>
      </div>
    </section>

    <section class="mt-8">
      <div class="rounded-3xl p-6 bg-white border border-slate-200 shadow-xl">
        <h3 class="text-lg font-semibold mb-3">Kh√°m ph√° ƒë·ªãa ƒëi·ªÉm</h3>

        <div class="flex gap-3">
          <input
            id="placeInput"
            type="text"
            placeholder="Nh·∫≠p t√™n th√†nh ph·ªë (VD: Da Nang, Ha Noi)..."
            class="flex-1 px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-brand-100"
          />
          <button
            id="btnSearch"
            class="px-5 py-3 rounded-xl bg-brand-600 text-white font-semibold shadow hover:bg-brand-700"
          >
            T√¨m
          </button>
        </div>

        <p id="statusText" class="text-sm text-slate-500 mt-2 min-h-[20px]"></p>

        <div id="weatherCard" class="hidden mt-4 p-5 rounded-2xl bg-gradient-to-r from-blue-500 to-cyan-400 text-white shadow-lg flex items-center justify-between">
            <div class="flex items-center gap-4">
                <img id="weatherIcon" src="" alt="Weather Icon" class="w-16 h-16 bg-white/20 rounded-full shadow-sm">
                <div>
                    <div class="flex items-baseline gap-2">
                        <h2 id="weatherTemp" class="text-4xl font-bold">--¬∞</h2>
                        <span id="weatherMain" class="text-lg font-medium">--</span>
                    </div>
                    <p id="weatherDesc" class="text-sm opacity-90 capitalize">--</p>
                    <div class="text-xs opacity-80 mt-1 flex gap-3">
                        <span id="weatherHumid">üí¶ --%</span>
                        <span id="weatherWind">üí® -- m/s</span>
                    </div>
                </div>
            </div>
            <div class="text-right">
                <p id="weatherCity" class="text-xl font-bold">--</p>
                <p class="text-xs opacity-75">Th·ªùi ti·∫øt hi·ªán t·∫°i</p>
            </div>
        </div>
        <div id="map" class="mt-6"></div>

        <h4 class="text-md font-semibold mt-4">5 ƒë·ªãa ƒëi·ªÉm l√¢n c·∫≠n:</h4>
        <ul id="poiList" class="mt-2 space-y-2 text-sm text-slate-700"></ul>
      </div>
    </section>

    <section class="mt-8">
      <div class="rounded-3xl p-6 bg-white border border-slate-200 shadow-xl">
        <div class="flex items-center justify-between gap-3">
          <h3 class="text-lg font-semibold">Ghi ch√∫ chuy·∫øn ƒëi</h3>
          <span id="authHint" class="text-sm text-slate-500">ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u.</span>
        </div>

        <form id="noteForm" class="mt-4 grid md:grid-cols-[1fr_auto] gap-3">
          <input id="noteInput" type="text" placeholder="Note l·∫°i ƒë·ªãa ƒëi·ªÉm hay..." class="px-4 py-3 rounded-xl border border-slate-200 bg-slate-50 focus:bg-white focus:outline-none focus:ring-4 focus:ring-brand-100" />
          <button class="px-5 py-3 rounded-xl bg-brand-600 text-white font-semibold shadow hover:bg-brand-700 disabled:opacity-50" disabled>
            L∆∞u
          </button>
        </form>

        <ul id="noteList" class="mt-4 space-y-2"></ul>
      </div>
    </section>

    <footer class="py-10 text-center text-sm text-slate-500">
      Created for Lab 05 Assignment
    </footer>
  </div>

  <script type="module">
    /* -----------------------------------------------------------
       1. C·∫§U H√åNH FIREBASE & API KEY
       ----------------------------------------------------------- */
    const firebaseConfig = {
      apiKey: "AIzaSyCamUCmlvjUJFm4s4dH6wCJAJqXdh6kIpA",
      authDomain: "explore-map-df995.firebaseapp.com",
      projectId: "explore-map-df995",
      storageBucket: "explore-map-df995.firebasestorage.app",
      messagingSenderId: "519785561982",
      appId: "1:519785561982:web:a3984ca81ca51b01f33d2f",
      measurementId: "G-DLBYFLYFZR"
    };

    // --- [QUAN TR·ªåNG] API KEY OPENWEATHERMAP C·ª¶A B·∫†N ---
    // B·∫°n c√≥ th·ªÉ d√πng key demo n√†y ho·∫∑c thay b·∫±ng key c·ªßa b·∫°n n·∫øu b·ªã l·ªói limit
    const WEATHER_API_KEY = "aff9cfd8832030b4c0294eb06c0e5fc4"; 

    /* -----------------------------------------------------------
       2. IMPORT LIBRARY
       ----------------------------------------------------------- */
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
    import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";

    // Init Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    /* -----------------------------------------------------------
       3. LOGIC X·ª¨ L√ù UI & AUTH
       ----------------------------------------------------------- */
    const btnSignIn = document.getElementById("btnSignIn");
    const btnSignOut = document.getElementById("btnSignOut");
    const userChip = document.getElementById("userChip");
    const avatar = document.getElementById("avatar");
    const displayName = document.getElementById("displayName");
    const authHint = document.getElementById("authHint");
    const noteForm = document.getElementById("noteForm");
    const noteInput = document.getElementById("noteInput");
    const noteList = document.getElementById("noteList");
    const provider = new GoogleAuthProvider();

    btnSignIn.classList.remove("hidden");
    btnSignIn.addEventListener("click", async () => {
      try { await signInWithPopup(auth, provider); } 
      catch (e) { alert(e.message); }
    });
    btnSignOut.addEventListener("click", () => signOut(auth));

    let unsubNotes = null;

    onAuthStateChanged(auth, (user) => {
      if (user) {
        btnSignIn.classList.add("hidden");
        userChip.classList.remove("hidden");
        avatar.src = user.photoURL || "https://ui-avatars.com/api/?name=User";
        displayName.textContent = user.displayName || "User";
        authHint.textContent = "ƒê√£ s·∫µn s√†ng.";
        noteForm.querySelector("button").disabled = false;

        if (unsubNotes) unsubNotes();
        const q = query(collection(db, "notes"), where("uid", "==", user.uid), orderBy("createdAt", "desc"));
        unsubNotes = onSnapshot(q, (snap) => {
          noteList.innerHTML = "";
          snap.forEach((doc) => {
            const li = document.createElement("li");
            const data = doc.data();
            li.className = "flex items-center justify-between px-4 py-3 rounded-xl border bg-slate-50 border-slate-200";
            li.innerHTML = `<span class="truncate">${data.text}</span><span class="text-xs text-slate-500">${data.createdAt?.toDate?.().toLocaleDateString() || "v·ª´a xong"}</span>`;
            noteList.appendChild(li);
          });
        });
      } else {
        btnSignIn.classList.remove("hidden");
        userChip.classList.add("hidden");
        authHint.textContent = "ƒêƒÉng nh·∫≠p ƒë·ªÉ l∆∞u note.";
        noteForm.querySelector("button").disabled = true;
        noteList.innerHTML = "";
      }
    });

    noteForm.addEventListener("submit", async (e) => {
      e.preventDefault();
      const user = auth.currentUser;
      const text = (noteInput.value || "").trim();
      if (!user || !text) return;
      await addDoc(collection(db, "notes"), { uid: user.uid, text, createdAt: serverTimestamp() });
      noteInput.value = "";
    });

    /* -----------------------------------------------------------
       4. LOGIC B·∫¢N ƒê·ªí & TH·ªúI TI·∫æT (WEATHER API)
       ----------------------------------------------------------- */
    const placeInput = document.getElementById("placeInput");
    const btnSearch = document.getElementById("btnSearch");
    const statusText = document.getElementById("statusText");
    const poiList = document.getElementById("poiList");
    
    // Weather UI Elements
    const weatherCard = document.getElementById("weatherCard");
    const weatherTemp = document.getElementById("weatherTemp");
    const weatherMain = document.getElementById("weatherMain");
    const weatherDesc = document.getElementById("weatherDesc");
    const weatherCity = document.getElementById("weatherCity");
    const weatherIcon = document.getElementById("weatherIcon");
    const weatherHumid = document.getElementById("weatherHumid");
    const weatherWind = document.getElementById("weatherWind");

    // Init Map
    const map = L.map("map").setView([16.05, 108.2], 6);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19 }).addTo(map);
    let markerGroup = L.layerGroup().addTo(map);

    function setStatus(msg) { statusText.textContent = msg; }

    // H√†m g·ªçi API Th·ªùi ti·∫øt
    async function getWeather(lat, lon) {
        try {
            // G·ªçi API OpenWeatherMap (ƒë∆°n v·ªã metric: ƒë·ªô C, lang: vi)
            const url = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&appid=${WEATHER_API_KEY}&units=metric&lang=vi`;
            const res = await fetch(url);
            if (!res.ok) throw new Error("L·ªói l·∫•y th·ªùi ti·∫øt");
            
            const data = await res.json();
            renderWeather(data);
        } catch (error) {
            console.error(error);
            weatherCard.classList.add("hidden");
        }
    }

    // H√†m hi·ªÉn th·ªã d·ªØ li·ªáu th·ªùi ti·∫øt l√™n th·∫ª
    function renderWeather(data) {
        weatherCard.classList.remove("hidden");
        
        const temp = Math.round(data.main.temp);
        const desc = data.weather[0].description;
        const main = data.weather[0].main;
        const iconCode = data.weather[0].icon;
        const humid = data.main.humidity;
        const wind = data.wind.speed;
        const cityName = data.name;

        weatherTemp.textContent = `${temp}¬∞`;
        weatherMain.textContent = main; // M∆∞a/N·∫Øng...
        weatherDesc.textContent = desc;
        weatherCity.textContent = cityName;
        weatherHumid.textContent = `üí¶ ${humid}%`;
        weatherWind.textContent = `üí® ${wind} m/s`;
        
        // L·∫•y icon t·ª´ OpenWeather
        weatherIcon.src = `https://openweathermap.org/img/wn/${iconCode}@2x.png`;
    }

    // X·ª≠ l√Ω t√¨m ki·∫øm
    async function searchPlace() {
      const query = placeInput.value.trim();
      if (!query) { setStatus("Vui l√≤ng nh·∫≠p t√™n ƒë·ªãa ƒëi·ªÉm."); return; }

      setStatus("ƒêang t√¨m ki·∫øm...");
      weatherCard.classList.add("hidden"); // ·∫®n th·∫ª th·ªùi ti·∫øt c≈©

      // 1. Geocoding (L·∫•y t·ªça ƒë·ªô t·ª´ t√™n)
      const nominatimUrl = "https://nominatim.openstreetmap.org/search?format=json&limit=1&q=" + encodeURIComponent(query);
      
      try {
          const res = await fetch(nominatimUrl);
          const data = await res.json();

          if (!data.length) {
            setStatus("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm n√†y.");
            return;
          }

          const { lat, lon, display_name } = data[0];
          const latNum = parseFloat(lat);
          const lonNum = parseFloat(lon);

          // C·∫≠p nh·∫≠t b·∫£n ƒë·ªì
          map.setView([latNum, lonNum], 13);
          setStatus("ƒê√£ t√¨m th·∫•y: " + display_name);

          // 2. G·ªçi API Th·ªùi ti·∫øt ngay khi c√≥ t·ªça ƒë·ªô
          getWeather(latNum, lonNum);

          // 3. T√¨m ƒë·ªãa ƒëi·ªÉm l√¢n c·∫≠n (Overpass API)
          fetchPOIs(latNum, lonNum);

      } catch (e) {
          setStatus("L·ªói k·∫øt n·ªëi. Vui l√≤ng th·ª≠ l·∫°i.");
          console.error(e);
      }
    }

    async function fetchPOIs(lat, lon) {
        const overpassQuery = `
            [out:json][timeout:25];
            (
              node(around:3000,${lat},${lon})["tourism"];
              node(around:3000,${lat},${lon})["amenity"="cafe"];
            );
            out 5;
        `;
        
        try {
            const res = await fetch("https://overpass-api.de/api/interpreter", {
                method: "POST",
                body: overpassQuery,
            });
            const data = await res.json();
            
            poiList.innerHTML = "";
            markerGroup.clearLayers();

            if (!data.elements?.length) {
                poiList.innerHTML = "<li class='text-slate-400 italic'>Kh√¥ng c√≥ ƒëi·ªÉm du l·ªãch/cafe g·∫ßn ƒë√¢y.</li>";
                return;
            }

            data.elements.forEach((el, idx) => {
                const name = el.tags?.name || "ƒê·ªãa ƒëi·ªÉm kh√¥ng t√™n";
                const type = el.tags?.tourism || el.tags?.amenity || "POI";
                
                // Marker tr√™n b·∫£n ƒë·ªì
                const marker = L.marker([el.lat, el.lon]).addTo(markerGroup)
                    .bindPopup(`<b>${name}</b><br>${type}`);
                
                // List b√™n d∆∞·ªõi
                const li = document.createElement("li");
                li.className = "border-b border-slate-100 py-2 cursor-pointer hover:text-brand-600 flex justify-between";
                li.innerHTML = `<span>${idx+1}. ${name}</span> <span class="text-xs bg-slate-100 px-2 py-1 rounded text-slate-500">${type}</span>`;
                li.onclick = () => {
                    map.setView([el.lat, el.lon], 16);
                    marker.openPopup();
                };
                poiList.appendChild(li);
            });

        } catch (e) {
            console.error("L·ªói t·∫£i POI", e);
        }
    }

    // Event Listeners
    btnSearch.addEventListener("click", searchPlace);
    placeInput.addEventListener("keydown", (e) => { if (e.key === "Enter") searchPlace(); });

  </script>
</body>
</html>